<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body {
        font-family: Helvetica, Arial, sans-serif
      }

      h1 {
        background-color: #2a5599;
        color: white;
        padding: 5px;
        text-align: center;
      }

      .container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .legend {
        font-size: 12px;
      }

      .tick {
        font-size: 10px;
      }

      .grid {
        stroke-opacity: 0.25;
      }
    </style>
    <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>

  <body>
    <h1>Net Donated and Received Map</h1>
    <div class="container">
      <svg id="countries-chart"></svg>
    </div>

    <script type="text/javascript">
      let store = {}

      function loadData() {
        return Promise.all([
          d3.csv('aiddata-countries-only.csv'),
          d3.json('countries.geo.json'),
        ]).then(datasets => {
          store.aiddata = datasets[0]
          store.geoJSON = datasets[1]
          return store
        })
      }

      function groupByCountry(aidData, geoJSON) {
        let result_map = aidData.reduce((result, d) => {
          let currentDonor = result[d.donor] || {
            'country': d.donor,
            'donated_amount': 0,
            'received_amount': 0,
            'geo': geoJSON.features.filter(f => f.properties.name == d.donor)[0]
          }
          let currentRecipient = result[d.recipient] || {
            'country': d.recipient,
            'donated_amount': 0,
            'received_amount': 0,
            'geo': geoJSON.features.filter(f => f.properties.name == d.recipient)[0]
          }

          currentDonor.donated_amount += +d.commitment_amount_usd_constant
          currentRecipient.received_amount += +d.commitment_amount_usd_constant

          result[d.donor] = currentDonor
          result[d.recipient] = currentRecipient

          return result
        }, {})

        store.countries_map = result_map

        result_list = Object.keys(result_map).map(key => result_map[key])

        store.countries_list = result_list

        return result_list
      }

      function getCountriesChartConfig() {
        let width = 1500
        let height = 850
        let margin = {
          top: 20,
          bottom: 10,
          left: 10,
          right: 10
        }

        let bodyHeight = height - margin.top - margin.bottom
        let bodyWidth = width - margin.left - margin.right

        let container = d3.select('#countries-chart')
        container
          .attr('width', width)
          .attr('height', height)

        return {width, height, margin, bodyHeight, bodyWidth, container}
      }

      function getMapProjection(config) {
        let {width, height} = config
        let projection = d3.geoNaturalEarth1()
        projection
          .scale(300)
          .translate([width/2, height/2 + 20])

        store.mapProjection = projection
        return projection
      }

      function getMapScales(countries) {
        let maximumDonatedAmount = d3.max(countries, d => d.donated_amount)
        let maximumReceivedAmount = d3.max(countries, d => d.received_amount)
        let maximumAmount = d3.max([maximumDonatedAmount, maximumReceivedAmount])

        let circleScale = d3.scaleLinear()
          .range([0, 25])
          .domain([0, maximumAmount])

        return {circleScale}
      }

      function drawDonationMap(geoJSON) {
        let config = getCountriesChartConfig()
        let container = config.container
        let projection = getMapProjection(config)
        let path = d3.geoPath()
          .projection(projection)

        let thresholds = [1e9, 10e9, 100e9]
        let donatedColorScale = d3.scaleThreshold()
          .range(d3.schemeBlues[thresholds.length + 1])
          .domain(thresholds)
        let receivedColorScale = d3.scaleThreshold()
          .range(d3.schemeReds[thresholds.length + 1])
          .domain(thresholds)

        container.selectAll('path')
          .data(geoJSON.features)
          .enter()
          .append('path')
          .attr('d', d => path(d))
          .attr('stroke', '#e0e0e0')
          .attr('fill', function(d) {
            country = store.countries_map[d.properties.name]
            if (country) {
              let netValue = country.donated_amount - country.received_amount
              let color = (netValue > 0) ? donatedColorScale(netValue) : receivedColorScale(-netValue)

              if (d.properties.name == "Australia") {
                console.log(netValue, country.donated_amount, country.received_amount)
              }
              return color
            } else {
              return '#fafafa'
            }
          })

        // Legend
        const width = 260
        const length = donatedColorScale.range().length

        const x = d3.scaleLinear()
            .domain([1, length - 1])
            .rangeRound([width / length, width * (length - 1) / length])

        let legend = container
          .append('g')
          .attr('class', 'legend')
          .attr('transform', `translate(900, 750)`)

        let donated = legend.append('g')
          .attr('transform', `translate(${width}, 0)`)

        donated.selectAll('rect')
          .data(donatedColorScale.range())
          .join('rect')
            .attr('height', 8)
            .attr('x', (d, i) => x(i))
            .attr('width', (d, i) => x(i + 1) - x(i))
            .attr('fill', d => d)

        donated.append('text')
            .attr('y', -6)
            .attr('x', width)
            .attr('fill', 'currentColor')
            .attr('text-anchor', 'end')
            .attr('font-weight', 'bold')
            .text('Donated amount')

        donated.call(d3.axisBottom(x)
            .tickSize(13)
            .tickFormat(i => `$${donatedColorScale.domain()[i - 1]/1e9}B`)
            .tickValues(d3.range(1, length)))
          .select('.domain')
            .remove()

        let received = legend.append('g')

        received.selectAll('rect')
          .data(receivedColorScale.range().reverse())
          .join('rect')
            .attr('height', 8)
            .attr('x', (d, i) => x(i))
            .attr('width', (d, i) => x(i + 1) - x(i))
            .attr('fill', d => d)

        received.append('text')
            .attr('y', -6)
            .attr('fill', 'currentColor')
            .attr('text-anchor', 'start')
            .attr('font-weight', 'bold')
            .text('Received amount')

        received.call(d3.axisBottom(x)
            .tickSize(13)
            .tickFormat(i => `$${receivedColorScale.domain().reverse()[i - 1]/1e9}B`)
            .tickValues(d3.range(1, length)))
          .select('.domain')
            .remove()
      }

      function showData() {
        let countries_list = groupByCountry(store.aiddata, store.geoJSON)
        console.log(store)
        drawDonationMap(store.geoJSON)
      }

      loadData().then(showData)
    </script>
  </body>
</html>